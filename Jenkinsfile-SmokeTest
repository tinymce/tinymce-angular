#!groovy
@Library('waluigi@release/7') _

properties([
  disableConcurrentBuilds(),
  buildDiscarder(logRotator(
    artifactDaysToKeepStr: '',
    artifactNumToKeepStr: '1',
    daysToKeepStr: '',
    numToKeepStr: '50'
  )),
  parameters([
    string(defaultValue: 'Tinymce-Angular-SmokeTest', description: 'The test directory to run', name: 'TEST_DIR', trim: false),
  ])
])


def runSmokeTests(Map args = new LinkedHashMap()) {
  // String stagingJwtCredentials = 'informant-staging-jwt'
  // String prodJwtCredentials = 'informant-production-jwt'
  String customRouteFilePath = 'version.json'
  String routFileContent = '''
                [{
                  "request": {
                    "method": "get",
                    "path": "/custom/integration/info"
                  },
                  "response": {
                    "status": 200,
                    "json": {
                      "version": "$nextVersion"
                    }
                  }
                }]
                '''

  String testDir = args.test_dir ?: 'smoke'
  String additionalArgs = "--chunk 20 --totalTimeout 1800000 --singleTimeout 90000 --retries 3"

  def platforms = args.platforms ?: [
    // [ browser: "chrome", provider: "aws", buckets: 2 ],
    // [ browser: "firefox", provider: "aws", buckets: 2 ],
    [ browser: "chrome", provider: "lambdatest" ],
    [ browser: "firefox", provider: "lambdatest" ],
    [ browser: "safari", provider: "lambdatest" ],
    [ browser: "edge", provider: "lambdatest" ]
  ]

  def processes = [:]

  for (int i = 0; i < platforms.size(); i++) {
  
    def platform = platforms.get(i)
    def buckets = platform.buckets ?: 1

    for (int bucket = 1; bucket <= buckets; bucket++) {
      // clousure var - don't inline or jenkins complains
      def currBucket = bucket
      def suffix = currBucket == 1 ? '' : "-${currBucket}"

      if (platform.provider) {
        // Run using remote provider
        def name = "${platform.browser}-${platform.provider}${suffix}"
        def testName = "TinyMCE-Angular-SmokeTest_${name}"
        processes[name] = {
          tinyPods.node {
            stage("${name}") {
              bedrockRemoteTools.tinyWorkSishTunnel()
              bedrockRemoteTools.withRemoteCreds(platform.provider) {
                def nextVersion = sh(script: 'npm view @angular/core@next version', returnStdout: true).toString().trim()
                
                sh 'yarn add @angular/animations@next @angular/common@next @angular/compiler@next @angular/core@next @angular/forms@next @angular/platform-browser@next @angular-devkit/build-angular@next @angular/cli@next @angular/compiler-cli@next'
                sh 'echo ${routFileContent} > ${customRouteFilePath}'

                sh 'cat ${customRouteFilePath}'
                sh 'yarn build'

                sh 'yarn bedrock-auto -b ${platform.browser} -f tinymce-angular-component/src/test/ts/smoke-test/VerifyIntegrationTest.ts --chunk 20 --totalTimeout 1800000 --singleTimeout 90000 --retries 3 --remote lambdatest --customRoutes ${customRouteFilePath}'

									junit allowEmptyResults: true, testResults: 'scratch/TEST-*.xml'
									if (testStatus == 4) {
										unstable("Tests failed for ${name}")
									} else if (testStatus != 0) {
										error("Unexpected error running tests for ${name} so passing failure as exist code")
									}
              }

                //   bedrockTests(
                //     name: name,
                //     browser: platform.browser,
                //     testDirs: [ "tinymce-angular-component/src/test/ts/browser" ],
                //     bucket: currBucket,
                //     buckets: buckets,
                //     custom: customArgs
                //   )
                // }
              }
            }
          }
       }
    }

  }

  parallel processes
}


timestamps {
  tinyPods.node(tag: '20') {
    stage("deps") {
      yarnInstall()
    }

    stage("tests") {
      runSmokeTests(
        platforms: [
          [ browser: "firefox", provider: "lambdatest" ]
        ]
      )
    }
  }
}
