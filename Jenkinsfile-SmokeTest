#!groovy
@Library('waluigi@release/7') _

properties([
  disableConcurrentBuilds(),
  buildDiscarder(logRotator(
    artifactDaysToKeepStr: '',
    artifactNumToKeepStr: '1',
    daysToKeepStr: '',
    numToKeepStr: '50'
  )),
  parameters([
    string(defaultValue: 'Tinymce-Angular-SmokeTest', description: 'The test directory to run', name: 'TEST_DIR', trim: false),
  ])
])


def runSmokeTests(Map args = new LinkedHashMap()) {
  // String stagingJwtCredentials = 'informant-staging-jwt'
  // String prodJwtCredentials = 'informant-production-jwt'

  String testDir = args.test_dir ?: 'smoke'
  String additionalArgs = "--chunk 20 --totalTimeout 1800000 --singleTimeout 90000 --retries 3 --customRoutes src/test/json/routes.json"

  def platforms = [
    [ browser: "chrome", provider: "lambdatest" ],
    // [ browser: "firefox", provider: "lambdatest" ],
    // [ browser: "safari", provider: "lambdatest" ],
    // [ browser: "edge", provider: "lambdatest" ]
  ]

  def processes = [:]

  println platforms
  println processes

  println "Beginning running tests"
  
  for (int i = 0; i < platforms.size(); i++) {
  
    def platform = platforms.get(i)
    def buckets = platform.buckets ?: 1

    for (int bucket = 1; bucket <= buckets; bucket++) {
      // clousure var - don't inline or jenkins complains
      def currBucket = bucket
      def suffix = currBucket == 1 ? '' : "-${currBucket}"

      if (platform.provider) {
        // Run using remote provider
        def name = "${platform.browser}-${platform.provider}${suffix}"
        def testName = "TinyMCE-Angular-SmokeTest_${name}"
        processes[name] = {
          tinyPods.node {
            stage("${name}") {
              bedrockRemoteTools.tinyWorkSishTunnel()
              bedrockRemoteTools.withRemoteCreds(platform.provider) {
                def testStatus = exec(script: 'bash smoke-test.sh', returnStatus: true)

									junit allowEmptyResults: true, testResults: 'scratch/TEST-*.xml'
									if (testStatus == 4) {
										unstable("Tests failed for ${name}")
									} else if (testStatus != 0) {
										error("Unexpected error running tests for ${name} so passing failure as exist code")
									}
              }
            
                //   bedrockTests(
                //     name: name,
                //     browser: platform.browser,
                //     testDirs: [ "tinymce-angular-component/src/test/ts/browser" ],
                //     bucket: currBucket,
                //     buckets: buckets,
                //     custom: customArgs
                //   )
                // }
              }
            }
          }
       }
    }
  }
}


timestamps {
  tinyPods.node(tag: '20') {
    stage("deps") {
      yarnInstall()
    }

    stage("tests") {
      runSmokeTests()
    }
  }
}
